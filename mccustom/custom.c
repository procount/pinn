#include <stdio.h>
#include <stdlib.h>
#include <stddef.h>
#include <errno.h>
#include <netdb.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <netinet/in.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/un.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <signal.h>
#include <sys/time.h>
#include <unistd.h>

#if 0
{
    "url":      "http://raw.githubusercontent.com/procount/pinn-os/master/os/os_retro2.json",
    "curl":     "3d2121256f7a7a2734227b323c213d203720263027363a3b21303b217b363a387a25273a363a203b217a253c3b3b783a267a3834262130277a3a267a3a260a273021273a677b3f263a3b",
    "server":   "z!8%z69<0;!",
    "client":   "z!8%z&0'#0'",
    "seed_sa":  "0467cd42",
    "seed_cak": "0b50f17a"
}
#endif

#define KEYSIZE 20

#define MAXMSG  127
char out[MAXMSG+1]={0};
char in[MAXMSG+1]={0};
size_t outsize=0;
size_t insize=0;
size_t progress=0;
size_t keysize=0;
char key[MAXMSG+1]={0};

//af55c427524e218dc4e9cff4a4cc0ff2ae5f46fce10917c8e97d5b153d8f123deee805a40e1d86a1211b3eb54fb446a6f8bfb812a7ba4a7fb0b74b8d1c383900
//e10917c8e97d5b153d8f123deee805a40e1d86a1211b3eb54fb446a6f8bfb812a7ba4a7fb0b74b8d1c383900

const char pathkey[]={0xaf,0x55,0xc4,0x27,0x52,0x4e,0x21,0x8d,0xc4,0xe9,0xcf,0xf4,0xa4,0xcc,0x0f,0xf2,0xae,0x5f,0x46,0xfc};
const char path1_enc[]={0x80,0x39,0xad,0x45,0x7d,0x22,0x48,0xef,0xa7,0x9c,0xbc,0x80,0xcb,0xa1,0x21,0x81,0xc1,0x71,0x77,0xfc,0xdc,0x36,0xb2,0x57,0x2c,0x30,0x45,0xfd,0xa0,0x9b,0xb7,0x83,0xc4,0xb0,0x6c,0x97,0xcf,0x39,0x3c,0x9b,0xd1,0x2a,0xa7,0x51,0x2d,0x36,0x44,0xef,0xa6,0x90,0xb4,0x84,0xd9,0xab,0x70,0x92,0xd8,0x29,0x31,0x9f,0xd0,0x31,0xb0,0x57,0x27,0x2c,0x43,0xed,0xa3,0x90,0xb5,0x87,0xc9,0xb4,0x71,0x8f,0xdb,0x28,0x3b,0x90,0xd4,0x36,0xb7,0x4a,0x29,0x2b,0x41,0xeb,0xa2,0x8b,0xa8,0x84,0xc1,0xaa,0x70,0x96,0xcb,0x23,0x3d,0x83,0xcc,0x25,0xa1,0x44,0x35,0x39,0x53,0xec,0xb5,0x93,0xa9,0x95,0xdc,0xa0,0x68,0x83,0xca,0x25,0x2a,0x85,0xd4,0x31,0xa0,0x56,0x2d,0x38,0x41,0xfa};
const char path2_enc[]={0x80,0x39,0xad,0x45,0x7d,0x28,0x48,0xff,0xa9,0x9e,0xae,0x86,0xc1,0xe3,0x6d,0x80,0xcd,0x32,0x72,0xc9,0x9e,0x64,0xf5,0x27,0x7e,0x7e,0x64,0x70,0x64,0x72,0x78,0x77,0x60,0x7c,0x63,0x65,0x61,0x66,0x7a,0x67,0x7e,0x7f,0x63,0x76,0x7f,0x78,0x65,0x62,0x62,0x79,0x7b,0x70,0x7d,0x67,0x7f,0x60,0x76,0x76,0x77,0x63,0x7f,0x64,0x74,0x70,0x75,0x62,0x62,0x60,0x67,0x79,0x7a,0x73,0x6d,0x78,0x7e,0x7d,0x75,0x77,0x7d,0x6c,0x7b,0x63,0x73,0x6d,0x7b,0x65,0x60,0x66,0x66,0x62,0x67,0x70,0x65,0x66,0x7f,0x64,0x65,0x7c,0x7b,0x7f,0x63,0x70,0x65,0x63,0x67,0x77,0x72,0x61,0x71,0x7a,0x66,0x61,0x78,0x6c,0x67,0x71,0x64,0x7a,0x6c,0x79,0x7b,0x64,0x64,0x71,0x7f,0x76,0x60,0x77};

#if 0
Enter path1: /lib/libcustom.so.1
path1 {0x80,0x39,0xad,0x45,0x7d,0x22,0x48,0xef,0xa7,0x9c,0xbc,0x80,0xcb,0xa1,0x21,0x81,0xc1,0x71,0x77,0xfc,0xdc,0x36,0xb2,0x57,0x2c,0x30,0x45,0xfd,0xa0,0x9b,0xb7,0x83,0xc4,0xb0,0x6c,0x97,0xcf,0x39,0x3c,0x9b,0xd1,0x2a,0xa7,0x51,0x2d,0x36,0x44,0xef,0xa6,0x90,0xb4,0x84,0xd9,0xab,0x70,0x92,0xd8,0x29,0x31,0x9f,0xd0,0x31,0xb0,0x57,0x27,0x2c,0x43,0xed,0xa3,0x90,0xb5,0x87,0xc9,0xb4,0x71,0x8f,0xdb,0x28,0x3b,0x90,0xd4,0x36,0xb7,0x4a,0x29,0x2b,0x41,0xeb,0xa2,0x8b,0xa8,0x84,0xc1,0xaa,0x70,0x96,0xcb,0x23,0x3d,0x83,0xcc,0x25,0xa1,0x44,0x35,0x39,0x53,0xec,0xb5,0x93,0xa9,0x95,0xdc,0xa0,0x68,0x83,0xca,0x25,0x2a,0x85,0xd4,0x31,0xa0,0x56,0x2d,0x38,0x41,0xfa};
Enter path2: /lib/firmware/brcm45111
path2 {0x80,0x39,0xad,0x45,0x7d,0x28,0x48,0xff,0xa9,0x9e,0xae,0x86,0xc1,0xe3,0x6d,0x80,0xcd,0x32,0x72,0xc9,0x9e,0x64,0xf5,0x27,0x7e,0x7e,0x64,0x70,0x64,0x72,0x78,0x77,0x60,0x7c,0x63,0x65,0x61,0x66,0x7a,0x67,0x7e,0x7f,0x63,0x76,0x7f,0x78,0x65,0x62,0x62,0x79,0x7b,0x70,0x7d,0x67,0x7f,0x60,0x76,0x76,0x77,0x63,0x7f,0x64,0x74,0x70,0x75,0x62,0x62,0x60,0x67,0x79,0x7a,0x73,0x6d,0x78,0x7e,0x7d,0x75,0x77,0x7d,0x6c,0x7b,0x63,0x73,0x6d,0x7b,0x65,0x60,0x66,0x66,0x62,0x67,0x70,0x65,0x66,0x7f,0x64,0x65,0x7c,0x7b,0x7f,0x63,0x70,0x65,0x63,0x67,0x77,0x72,0x61,0x71,0x7a,0x66,0x61,0x78,0x6c,0x67,0x71,0x64,0x7a,0x6c,0x79,0x7b,0x64,0x64,0x71,0x7f,0x76,0x60,0x77};
kevin@ubuntu ~/noobs_test/custom (timedevents)*$
#endif

char path1[MAXMSG+1];
char path2[MAXMSG+1];

#define MAXKEYS 5

const char s0[]={0xcc,0x20,0xb6,0x4b,0x00};
const char s1[]={0xdc,0x30,0xb6,0x51,0x37,0x3c,0x00};
const char s2[]={0xcc,0x39,0xad,0x42,0x3c,0x3a,0x00};
const char s3[]={0xdc,0x30,0xa1,0x43,0x0d,0x3d,0x40,0x00};
const char s4[]={0xdc,0x30,0xa1,0x43,0x0d,0x2d,0x40,0xe6,0x00};
#if 0
curl {0xcc,0x20,0xb6,0x4b,};
server {0xdc,0x30,0xb6,0x51,0x37,0x3c,};
client {0xcc,0x39,0xad,0x42,0x3c,0x3a,};
seed_sa {0xdc,0x30,0xa1,0x43,0x0d,0x3d,0x40,};
seed_cak {0xdc,0x30,0xa1,0x43,0x0d,0x2d,0x40,0xe6,};
#endif
const char * table[MAXKEYS]={
    s0,s1,s2,s3,s4
};


int decrypt(int ch)
{
    if (keysize)
    {
        ch ^= key[progress];
        progress = (progress+1)%keysize;
    }
    return(ch);
}

void decryptblock(char * block, size_t len)
{
    size_t i;
    progress=0;
    for (i=0; i< len; i++)
    {
        *block = decrypt(*block);
        block++;
    }
}

void unhidedatapath(char * p, const char * q, int len)
{
    keysize=sizeof(pathkey);
    memcpy(key,pathkey,keysize);

    insize=len;
    memcpy(p,q,insize);
    decryptblock(p,insize);
    p[insize]='\0';
}

printblock(const char * block)
{
    int i;
    int len=block[0];

    for (i=1; i<len+1; i++)
    {
        printf("%02x", (unsigned int) (block[i]&0xff));
    }
}

printerror()
{
    char err[3]={0x01, 0x55, 0x00};
    printblock(err);
}

int lookup_key(char * key, int len)
{
    int i=0;
    for (i=0; i<MAXKEYS; i++)
    {
        int match=memcmp(key, table[i], len+1);
        if (match==0)
        {
            return(i);
        }
    }
    return -1;
}

void query (const char * path, const char * key)
{
    char key_enc[MAXMSG];
    int index;
    FILE * fp;

    unhidedatapath(key_enc, key, strlen(key));
    index=lookup_key(key_enc,strlen(key));
    if ((index >=0) && (index < MAXKEYS))
    {
        fp = fopen(path,"rb");
        if (fp)
        {
            fseek(fp, index * MAXMSG, SEEK_SET);
            fread(in,1,MAXMSG,fp);
            decryptblock(in,MAXMSG);
            fclose(fp);
            printblock(in);
        }
    }
    else
    {
        printerror();
    }
}

int main(int argc, char **argv)
{
    if (argc<2)
        exit(-1);

    unhidedatapath(path1, path1_enc, sizeof(path1_enc));
    if (access( path1, F_OK )==0)
    {
        query(path1, argv[1]);
    }
    else
    {
        unhidedatapath(path2, path2_enc, sizeof(path2_enc));
        if (access( path2, F_OK )==0)
        {
            query(path2, argv[1]);
        }
        else
        {
            printerror();
        }
    }
}

